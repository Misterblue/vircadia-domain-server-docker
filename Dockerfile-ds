# build a domain-server using vircadia-builder
FROM domain-server-build-base as domain-server-build

RUN echo UTC >/etc/timezone

# The tag to pull from the Project Athena source repository.
ARG TAG=master

# Tell the libraries not to use the interactive dialogs
ARG DEBIAN_FRONTEND=noninteractive
ARG TERM=linux

# =======================================
FROM ubuntu:18.04 as domain-server-run

RUN echo UTC >/etc/timezone

# The tag to pull from the Project Athena source repository. (Note defn in previous stage)
ARG TAG=master

# Tell the libraries not to use the interactive dialogs
ENV DEBIAN_FRONTEND noninteractive
ENV TERM linux

RUN adduser --disabled-password --gecos 'domain-server user' cadia

RUN mkdir -p /opt/vircadia/install_master \
    && mkdir -p /opt/vircadia/version \
    && mkdir -p /opt/vircadia/qt5-install/lib \
    && chown -R cadia:cadia /opt/vircadia

COPY --from=domain-server-build --chown=cadia:cadia /opt/vircadia/install_$TAG /opt/vircadia/install_master
COPY --from=domain-server-build --chown=cadia:cadia /opt/vircadia/qt5-install/lib /opt/vircadia/qt5-install/lib
COPY --from=domain-server-build --chown=cadia:cadia /opt/vircadia/builder-deps.txt /opt/vircadia/
# The service definitions are built and hidden in /root/.config
COPY --from=domain-server-build --chown=cadia:cadia /root/.config /home/cadia/.config

# Build version information is also in the image (generated by buildVersion.sh)
COPY --from=domain-server-build --chown=cadia:cadia /opt/vircadia/version /opt/vircadia/version

# Load some debugging and all the required packages
RUN apt-get update \
    && apt-get upgrade -y \
    && apt-get install -y vim \
    && apt-get install -y libssl-dev \
    && apt-get install -y $(cat /opt/vircadia/builder-deps.txt) \
    && apt-get clean \
    && rm -rf /var/lib/app/lists/*

USER cadia:cadia

RUN mkdir -p /home/cadia/.config \
    && mkdir -p /home/cadia/.local \
    && mkdir -p /home/cadia/log

COPY --chown=cadia:cadia files/start-domain-server.sh /home/cadia
COPY --chown=cadia:cadia files/start-ice-server.sh /home/cadia
COPY --chown=cadia:cadia files/getVersion.sh /home/cadia

VOLUME /home/cadia/.local
VOLUME /home/cadia/logs

# expose ports for domain server
EXPOSE 40100 40101 40102
EXPOSE 40100/udp 40101/udp 40102/udp

# expose ports for assignment client
EXPOSE 48000/udp 48001/udp 48002/udp 48003/udp 48004/udp 48005/udp 48006/udp

ENTRYPOINT ["/home/cadia/start-domain-server.sh"]

